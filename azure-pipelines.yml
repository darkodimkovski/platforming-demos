trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  - group: 'SUBSCRIPTION_BILLING_SCOPE'   # ← ADD THIS (exact name from Library)
  - name: azureServiceConnection
    value: 'DDI-TEST'
  - name: location
    value: 'norwayeast'
  - name: managementGroupId
    value: 'initno-sandboxes'

stages:
# ── Stage 1: Subscription Vending ─────────────────────────────────────────
- stage: VendSubscription
  displayName: 'Vend workload subscription'
  jobs:
  - job: Vend
    displayName: 'Create / reuse isolated subscription'
    steps:
    - task: AzureCLI@2
      name: vend
      displayName: 'Run subscription vending (Bicep)'
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail

          # Ensure yq/jq exist (ubuntu-latest usually has jq; yq can vary)
          if ! command -v yq >/dev/null 2>&1; then
            echo "Installing yq..."
            YQ_VERSION="v4.44.1"
            sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
            sudo chmod +x /usr/local/bin/yq
          fi
          command -v jq >/dev/null 2>&1 || { echo "jq not found"; exit 1; }

          # Fail fast if not provided
          if [[ -z "${SUBSCRIPTION_BILLING_SCOPE:-}" ]]; then
            echo "SUBSCRIPTION_BILLING_SCOPE is empty/missing. Define it as a secret pipeline variable."
            exit 1
          fi

          WORKLOAD_NAME="$(yq -r '.metadata.name // empty' score.yaml)"
          if [[ -z "$WORKLOAD_NAME" ]]; then
            echo "score.yaml missing required field: metadata.name"
            exit 1
          fi

          ENVIRONMENT="$(yq -r '.spec.environment // "dev"' score.yaml)"
          WORKLOAD_TYPE="$(yq -r '.spec.workloadType // "Production"' score.yaml)"
          OWNER_PRINCIPAL="$(yq -r '.spec.ownerPrincipalId // ""' score.yaml)"

          MG_ID="$(managementGroupId)"
          DEPLOY_NAME="vend-${WORKLOAD_NAME}-${ENVIRONMENT}-$(Build.BuildId)"

          az deployment mg create \
            --name "$DEPLOY_NAME" \
            --management-group-id "$MG_ID" \
            --location "$(location)" \
            --template-file infra/subscription-vending.bicep \
            --parameters \
              workloadName="$WORKLOAD_NAME" \
              environment="$ENVIRONMENT" \
              location="$(location)" \
              subscriptionBillingScope="$SUBSCRIPTION_BILLING_SCOPE" \
              managementGroupId="$MG_ID" \
              subscriptionWorkload="$WORKLOAD_TYPE" \
              ownerPrincipalId="$OWNER_PRINCIPAL" \
            -o none

          # Capture outputs
          OUTPUTS="$(az deployment mg show \
            --name "$DEPLOY_NAME" \
            --management-group-id "$MG_ID" \
            --query "properties.outputs" -o json)"

          SUB_ID="$(echo "$OUTPUTS" | jq -r '.subscriptionId.value')"
          if [[ -z "$SUB_ID" || "$SUB_ID" == "null" ]]; then
            echo "Failed to read subscriptionId from outputs:"
            echo "$OUTPUTS" | jq .
            exit 1
          fi

          echo "Vended subscriptionId: $SUB_ID"
          echo "##vso[task.setvariable variable=subscriptionId;isOutput=true]$SUB_ID"

          echo "$OUTPUTS" > vending-outputs.json
      env:
        # This pulls the secret pipeline variable into the script environment
        SUBSCRIPTION_BILLING_SCOPE: $(SUBSCRIPTION_BILLING_SCOPE)

    - task: PublishBuildArtifacts@1
      displayName: 'Publish vending outputs'
      inputs:
        PathtoPublish: 'vending-outputs.json'
        ArtifactName: 'vending-outputs'
        publishLocation: 'Container'

# ── Stage 2: Deploy Workload Resources ────────────────────────────────────
- stage: DeployWorkload
  displayName: 'Deploy workload resources'
  dependsOn: VendSubscription
  variables:
    subscriptionId: $[ stageDependencies.VendSubscription.Vend.outputs['vend.subscriptionId'] ]
  jobs:
  - job: Deploy
    displayName: 'Deploy PostgreSQL into vended subscription'
    steps:
    - task: AzureCLI@2
      displayName: 'Deploy workload Bicep'
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail

          if ! command -v yq >/dev/null 2>&1; then
            echo "Installing yq..."
            YQ_VERSION="v4.44.1"
            sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
            sudo chmod +x /usr/local/bin/yq
          fi

          WORKLOAD_NAME="$(yq -r '.metadata.name // empty' score.yaml)"
          [[ -n "$WORKLOAD_NAME" ]] || { echo "score.yaml missing metadata.name"; exit 1; }

          ENVIRONMENT="$(yq -r '.spec.environment // "dev"' score.yaml)"
          PG_VERSION="$(yq -r '.spec.postgresVersion // "16"' score.yaml)"
          COMPUTE_TIER="$(yq -r '.spec.computeTier // "Burstable"' score.yaml)"
          STORAGE_GB="$(yq -r '.spec.storageSizeGb // 32' score.yaml)"

          SUB_ID="$(subscriptionId)"
          echo "Deploying into subscription: $SUB_ID"

          az account set --subscription "$SUB_ID"

          RG_NAME="rg-${WORKLOAD_NAME}-${ENVIRONMENT}"
          az group create --name "$RG_NAME" --location "$(location)" -o none

          DEPLOY_NAME="deploy-${WORKLOAD_NAME}-$(Build.BuildId)"

          az deployment group create \
            --name "$DEPLOY_NAME" \
            --resource-group "$RG_NAME" \
            --template-file main.bicep \
            --parameters \
              workloadName="$WORKLOAD_NAME" \
              environment="$ENVIRONMENT" \
              location="$(location)" \
              postgresVersion="$PG_VERSION" \
              computeTier="$COMPUTE_TIER" \
              storageSizeGb="$STORAGE_GB" \
            -o none

          az deployment group show \
            --name "$DEPLOY_NAME" \
            --resource-group "$RG_NAME" \
            --query "properties.outputs" \
            -o json > outputs.json

          echo "outputs.json:"
          cat outputs.json

    - task: PublishBuildArtifacts@1
      displayName: 'Publish deployment outputs (outputs.json)'
      inputs:
        PathtoPublish: 'outputs.json'
        ArtifactName: 'iac-outputs'
        publishLocation: 'Container'

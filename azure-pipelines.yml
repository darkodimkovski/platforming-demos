trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  azureServiceConnection: 'DDI-TEST'
  location: 'westeurope'

steps:
- task: AzureCLI@2
  displayName: 'Deploy PostgreSQL Flexible Server from workload spec'
  inputs:
    azureSubscription: '$(azureServiceConnection)'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euo pipefail

      # Parse workload spec
      WORKLOAD_NAME=$(yq -r '.metadata.name' score.yaml)
      ENVIRONMENT=$(yq -r '.spec.environment // "dev"' score.yaml)
      PG_VERSION=$(yq -r '.spec.postgresVersion // "16"' score.yaml)
      COMPUTE_TIER=$(yq -r '.spec.computeTier // "Burstable"' score.yaml)
      STORAGE_GB=$(yq -r '.spec.storageSizeGb // 32' score.yaml)

      echo "Workload: $WORKLOAD_NAME | Env: $ENVIRONMENT"

      # Resource group from workload name
      RG_NAME="rg-${WORKLOAD_NAME}-${ENVIRONMENT}"

      echo "Creating/ensuring resource group $RG_NAME..."
      az group create --name "$RG_NAME" --location "$(location)" -o none

      echo "Deploying bicep..."
      DEPLOY_NAME="deploy-${WORKLOAD_NAME}-$(Build.BuildId)"

      az deployment group create \
        --name "$DEPLOY_NAME" \
        --resource-group "$RG_NAME" \
        --template-file main.bicep \
        --parameters \
          workloadName="$WORKLOAD_NAME" \
          environment="$ENVIRONMENT" \
          location="$(location)" \
          postgresVersion="$PG_VERSION" \
          computeTier="$COMPUTE_TIER" \
          storageSizeGb="$STORAGE_GB" \
        -o none

      echo "Fetching deployment outputs..."
      az deployment group show \
        --name "$DEPLOY_NAME" \
        --resource-group "$RG_NAME" \
        --query "properties.outputs" \
        -o json > outputs.json

      echo "outputs.json:"
      cat outputs.json

- task: PublishBuildArtifacts@1
  displayName: 'Publish deployment outputs (outputs.json)'
  inputs:
    PathtoPublish: 'outputs.json'
    ArtifactName: 'iac-outputs'
    publishLocation: 'Container'
